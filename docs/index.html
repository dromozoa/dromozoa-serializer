<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>dromozoa-serializer</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/3.0.1/github-markdown.min.css">
<style>
.markdown-body {
  box-sizing: border-box;
  min-width: 200px;
  max-width: 980px;
  margin: 0 auto;
  padding: 45px;
}
@media (max-width: 767px) {
  .markdown-body {
    padding: 15px;
  }
}
</style>
</head>
<body>
<div class="markdown-body">

<h1>dromozoa-serializer</h1>

<h2>リンク</h2>

<ul>
  <li>RFC
    <ul>
      <li><a href="https://www.ietf.org/rfc/rfc8259.txt">The JavaScript Object Notation (JSON) Data Interchange Format</a></li>
      <li><a href="https://www.ietf.org/rfc/rfc4180.txt">Common Format and MIME Type for Comma-Separated Values (CSV) Files</a></li>
    </ul>
  </li>
  <li><a href="https://www.unicode.org/Public/UCD/latest/ucd/">UCD</a></li>
  <li><a href="https://www.post.japanpost.jp/zipcode/download.html">郵便番号データダウンロード</a></li>
</ul>

<h2>TODO</h2>

<ul>
  <li>新しい形式の策定
    <ul>
      <li>命令コードとオペランドを合併する</li>
      <li>バイナリ形式</li>
    </ul>
  </li>
  <li>メモリIO</li>
  <li>Luaコード生成</li>
  <li>Cコードの実装</li>
  <li>ベンチマーク対象データの変更
    <ul>
      <li>同一テーブルを複数回利用する</li>
    </ul>
  </li>
</ul>

<h2>ベンチマーク対象データ</h2>

<ul>
  <li>UCD</li>
  <li>郵便番号</li>
  <li>正規表現から生成したDFA</li>
</ul>

<h2>コード</h2>

<h3>Luaの値</h3>

<table>
  <tr>
    <th>major</th>
    <th>type</th>
    <th>minor</th>
    <th>name</th>
  </tr>
  <tr>
    <td>0</td>
    <td><code>LUA_TNIL</code></td>
    <td>N/A</td>
    <td><code>nil</code></td>
  </tr>
  <tr>
    <td rowspan="2">1</td>
    <td rowspan="2"><code>LUA_TBOOLEAN</code></td>
    <td>0</td>
    <td><code>false</code></td>
  </tr>
  <tr>
    <td>1</td>
    <td><code>true</code></td>
  </tr>
  <tr>
    <td rowspan="2">3</td>
    <td rowspan="2"><code>LUA_TNUMBER</code></td>
    <td>0</td>
    <td><code>LUA_TNUMFLT</code> (double)</td>
  </tr>
  <tr>
    <td>1</td>
    <td><code>LUA_TNUMINT</code> (int64_t)</td>
  </tr>
  <tr>
    <td rowspan="2">4</td>
    <td rowspan="2"><code>LUA_TSTRING</code></td>
    <td>0</td>
    <td><code>LUA_TSHRSTR</code></td>
  </tr>
  <tr>
    <td>1</td>
    <td><code>LUA_TLNGSTR</code></td>
  </tr>
  <tr>
    <td>5</td>
    <td><code>LUA_TTABLE</code></td>
    <td>N/A</td>
    <td><code>{}</code></td>
  </tr>
</table>

<h4>Lua 5.4ヘッダ</h4>

<pre class="prettyprint lang-c">
/* Variant tags for numbers */
#define LUA_TNUMFLT	(LUA_TNUMBER | (1 &lt;&lt; 4))  /* float numbers */
#define LUA_TNUMINT	(LUA_TNUMBER | (2 &lt;&lt; 4))  /* integer numbers */
</pre>

<pre class="prettyprint lang-c">
/* Variant tags for strings */
#define LUA_TSHRSTR	(LUA_TSTRING | (1 &lt;&lt; 4))  /* short strings */
#define LUA_TLNGSTR	(LUA_TSTRING | (2 &lt;&lt; 4))  /* long strings */
</pre>

<h4>Lua 5.3ヘッダ</h4>

<pre class="prettyprint lang-c">
/* Variant tags for numbers */
#define LUA_TNUMFLT	(LUA_TNUMBER | (0 &lt;&lt; 4))  /* float numbers */
#define LUA_TNUMINT	(LUA_TNUMBER | (1 &lt;&lt; 4))  /* integer numbers */
</pre>

<pre class="prettyprint lang-c">
/* Variant tags for strings */
#define LUA_TSHRSTR	(LUA_TSTRING | (0 &lt;&lt; 4))  /* short strings */
#define LUA_TLNGSTR	(LUA_TSTRING | (1 &lt;&lt; 4))  /* long strings */
</pre>

<h3>命令セット</h3>

<table>
  <tr>
    <th>code</th>
    <th>name</th>
  </tr>
  <tr>
    <td><code>1 ref</code></td>
    <td>Lookup</td>
  </tr>
  <tr>
    <td><code>2 data</code></td>
    <td>Integer (int64_t)</td>
  </tr>
  <tr>
    <td><code>3 data</code></td>
    <td>Number (double)</td>
  </tr>
  <tr>
    <td><code>4 size:data</code></td>
    <td>String (instant)</td>
  </tr>
  <tr>
    <td><code>5 ref size:data</code></td>
    <td>String (dictionary)</td>
  </tr>
  <tr>
    <td><code>6 ref size</code></td>
    <td>Table</td>
  </tr>
  <tr>
    <td><code>7 0</code></td>
    <td>End</td>
  </tr>
</table>

<h3>初期辞書</h3>

<table>
  <tr>
    <th>code</th>
    <th>value</th>
  </tr>
  <tr>
    <td>0</td>
    <td><code>nil</code></td>
  </tr>
  <tr>
    <td>1</td>
    <td><code>true</code></td>
  </tr>
  <tr>
    <td>2</td>
    <td><code>false</code></td>
  </tr>
</table>

<h2>RAMディスク</h2>

<h3>macOS</h3>

<pre>
man hdiutil
</pre>

<pre>
Creating a RAM-backed device and filesystem:

      NUMSECTORS=128000       # a sector is 512 bytes
      mydev=`hdiutil attach -nomount ram://$NUMSECTORS`
      newfs_hfs $mydev
      mkdir /tmp/mymount
      mount -t hfs $mydev /tmp/mymount
</pre>

<p>
簡易ベンチマークはRAMディスクを使っても速くならなかった。
</p>

</div>
<script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
</body>
</html>
